# AWS 서버의 /etc/nginx/sites-available/moa 에 복사할 설정

server {
    listen 80;
    server_name _;  # 도메인이 있다면 여기에 입력 (예: moa.example.com)

    # 파일 업로드 크기 제한
    client_max_body_size 100M;

    # ======================================
    # MOA Spring Legacy 앱 리버스 프록시
    # ======================================
    
    # 모든 요청을 Tomcat(Docker)으로 전달
    # ROOT.war로 배포했으므로 context path 없이 바로 접근
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 세션 유지
        proxy_set_header Cookie $http_cookie;
        proxy_cookie_path ~*^/.* /;
        
        # 타임아웃 설정
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
        
        # 버퍼링 비활성화 (실시간 응답)
        proxy_buffering off;
    }
    
    # API 엔드포인트 최적화
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # API 응답 캐싱 비활성화
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
    
    # 정적 리소스 캐싱
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://localhost:8080;
        expires 30d;
        add_header Cache-Control "public, immutable";
        gzip on;
        gzip_types text/css application/javascript image/svg+xml;
    }
    
    # WEB-INF 디렉토리 접근 차단 (보안)
    location ~ /WEB-INF/ {
        deny all;
        return 404;
    }
    
    # 헬스체크 엔드포인트
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # 에러 페이지
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
