<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.moa.reservation.accommodation.mapper.AccommodationMapper">
    <select id="searchAvailableAccomms" resultType="org.moa.reservation.accommodation.entity.AccommodationInfo">
        SELECT DISTINCT
            a.accom_id,
            a.hotel_name,
            a.address,
            a.location,
            a.latitude,
            a.longitude,
            a.description,
            a.hotel_image_url
        FROM
            accommodation_info a
        WHERE
            EXISTS (
            SELECT 1
            FROM accom_res av
            WHERE
                av.accom_id = a.accom_id
                AND av.status = 'AVAILABLE'
                AND av.checkin_day &gt;= #{checkinDay}
                AND av.checkin_day &lt; #{checkoutDay}
            )
            AND a.location = #{location}
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>
    <select id="searchAvailableRooms" resultType="org.moa.reservation.accommodation.entity.AccomRes">
        SELECT
            MAX(ar.accom_res_id) AS accomResId,
            ar.hotel_name AS hotelName,
            ar.room_type AS roomType,
            ar.room_image_url AS roomImageUrl,
            ar.max_guests AS maxGuests,
            ar.price AS price
        FROM
            accom_res ar
                LEFT JOIN
            accommodation_info a ON ar.accom_id = a.accom_id
        WHERE
            a.accom_id = #{accomId}
          AND a.location = #{location}
          AND ar.status = 'AVAILABLE'
          AND ar.max_guests &gt;= #{guests}
          AND ar.checkin_day &gt;= #{checkinTime}
          AND ar.checkin_day &lt; #{checkoutTime}
        GROUP BY
            ar.hotel_name, ar.room_type, ar.room_image_url, ar.max_guests, ar.price
        HAVING
            COUNT(*) &gt; 0
    </select>
    <select id="searchAccommById" resultType="org.moa.reservation.accommodation.entity.AccommodationInfo">
        SELECT
            accom_id,
            hotel_name,
            address,
            hotel_image_url
        FROM accommodation_info
        WHERE accom_id = #{accomId}
    </select>

    <select id="getAccommodationReservationsByTripId" resultType="org.moa.reservation.dto.ReservationItemResponseDto">
        SELECT
            ar.reservation_id as reservationId,
            ar.hotel_name as name,
            ar.accom_id as itemId,
            ai.hotel_image_url as imageUrl,
            td.day as date,
            ar.created_at as createdAt,
            'ACCOMMODATION' as resKind
        FROM accom_res ar
            JOIN trip_day td ON ar.trip_day_id = td.trip_day_id
            JOIN accommodation_info ai ON ar.accom_id = ai.accom_id
        WHERE td.trip_id = #{tripId}
          AND ar.status = 'CONFIRMED'
        ORDER BY td.day
    </select>

    <select id="getAccommodationReservationsByDateAndMember" resultType="org.moa.reservation.dto.ReservationItemResponseDto">
        SELECT
            ar.reservation_id as reservationId,
            ar.hotel_name as name,
            ar.accom_id as itemId,
            ai.hotel_image_url as imageUrl,
            td.day as date,
            ar.created_at as createdAt,
            'ACCOMMODATION' as resKind
        FROM accom_res ar
            JOIN trip_day td ON ar.trip_day_id = td.trip_day_id
            JOIN accommodation_info ai ON ar.accom_id = ai.accom_id
            JOIN trip t ON td.trip_id = t.trip_id
            JOIN trip_member tm ON t.trip_id = tm.trip_id
        WHERE td.trip_id = #{tripId}
          AND tm.member_id = #{memberId}
          AND td.day = #{date}
          AND ar.status = 'CONFIRMED'
        ORDER BY ar.created_at
    </select>
</mapper>
