<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.moa.reservation.restaurant.mapper.RestaurantMapper">

    <!-- 예약 가능한 식당 목록 -->
    <select id="findAvailableRestaurant" resultType="org.moa.reservation.restaurant.dto.RestaurantListResponseDto">
        SELECT rest_id,
               rest_name,
               address,
               rest_image_url,
               phone,
               description
        FROM restaurant_info
        WHERE category = #{category}
          AND rest_id IN (
            SELECT rest_id
            FROM trip_day td
                     JOIN trip t ON td.trip_id = t.trip_id
            WHERE t.trip_id = #{tripId}
              AND td.day = #{date}
        )
            LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>

    <!-- 페이지네이션을 위한 총 개수 -->
    <select id="countAvailableRestaurants" resultType="int">
        SELECT COUNT(*)
        FROM restaurant_info
        WHERE category = #{category}
          AND rest_id IN (
            SELECT rest_id
            FROM trip_day td
                     JOIN trip t ON td.trip_id = t.trip_id
            WHERE t.trip_id = #{tripId}
              AND td.day = #{date}
        )
    </select>

    <!-- 식당 정보 조회 -->
    <select id="findRestaurantInfo" resultType="org.moa.reservation.restaurant.dto.RestaurantInfoResponseDto">
        SELECT
            rest_id AS restId,
            rest_name AS restName,
            rest_image_url AS restImageUrl,
            address
        FROM restaurant_info
        WHERE rest_id = #{restId}
    </select>

    <!-- 예약 가능한 날짜 시간 조회 -->
    <select id="findAvailableSlotsByDate" resultType="org.moa.reservation.restaurant.dto.AvailableTimeResponseDto">
        SELECT
            daily_slot_id   AS dailySlotId,
            DATE_FORMAT(rds.time, '%H:%i') AS time,
            max_capacity    AS maxNum,
            (max_capacity - current_capacity) AS reservedNum,
            current_capacity AS availableNum
        FROM
            rest_daily_slot rds
        WHERE
            rest_id = #{restId}
          AND day = #{date}
          AND current_capacity > 0
    </select>

    <!-- 예약 인원 -->
    <update id="decreaseCapacity">
        UPDATE rest_daily_slot
        SET current_capacity = current_capacity - #{amount}
        WHERE daily_slot_id = #{dailySlotId}
          AND current_capacity >= #{amount}
    </update>

    <!-- dailySlotId 조회 -->
    <select id="findDailySlotId" resultType="long">
        SELECT daily_slot_id
        FROM rest_daily_slot
        WHERE rest_id = #{restId}
          AND day = #{date}
          AND time = #{time}
    </select>

    <!-- tripDayId 조회-->
    <select id="findTripDayId" resultType="long">
        SELECT trip_day_id
        FROM trip_day
        WHERE trip_id = #{tripId}
                  AND day = #{date}
    </select>

    <!-- reservationId 조회 -->
    <select id="findLastInsertedReservationId" resultType="long">
        SELECT LAST_INSERT_ID()
    </select>

    <!-- 예약 생성 -->
    <insert id="insertReservation" useGeneratedKeys="true" keyProperty="reservationId">
        INSERT INTO reservation (trip_day_id, res_kind)
        VALUES (#{tripDayId}, 'RESTAURANT')
    </insert>

    <!-- 식당 예약 생성 -->
    <insert id="insertRestaurantReservation">
        INSERT INTO rest_res (
            reservation_id,
            trip_day_id,
            rest_id,
            daily_slot_id,
            res_num,
            status,
            created_at
        )
        VALUES (
                   #{reservationId},
                   #{tripDayId},
                   #{restId},
                   #{dailySlotId},
                   #{resNum},
                   'reserved',
                   NOW()
               )
    </insert>


    <!-- 여행별 식당 예약 조회 -->
    <select id="findReservations" resultType="org.moa.reservation.restaurant.dto.RestaurantReservationResponseDto">
        SELECT
            rr.reservation_id AS reservationId,
            ri.rest_id AS restId,
            ri.rest_name AS restName,
            td.day AS date,
            rds.time AS time,
            rr.res_num AS resNum,
            rr.status
        FROM
            rest_res rr
                JOIN restaurant_info ri ON rr.rest_id = ri.rest_id
                JOIN trip_day td ON rr.trip_day_id = td.trip_day_id
                JOIN rest_daily_slot rds ON rr.daily_slot_id = rds.daily_slot_id -- 수정
        WHERE
            td.trip_id = #{tripId}
        ORDER BY td.day, rds.time
    </select>

    <!-- 식당 예약 상세 조회 -->
    <select id="findReservationDetail" resultType="org.moa.reservation.restaurant.dto.RestaurantReservationDetailDto">
        SELECT
            rr.rest_res_id     AS restResId,
            rr.reservation_id  AS reservationId,
            rr.trip_day_id     AS tripDayId,
            ri.rest_id         AS restId,
            ri.rest_name       AS restName,
            ri.address         AS address,
            ri.category        AS category,
            ri.rest_image_url  AS imageUrl,
            td.day             AS date,
            rds.time           AS time,
            rr.res_num         AS resNum,
            rr.status          AS status
        FROM
            rest_res rr
                JOIN restaurant_info ri ON rr.rest_id = ri.rest_id
                JOIN trip_day td ON rr.trip_day_id = td.trip_day_id
                JOIN rest_daily_slot rds ON rr.daily_slot_id = rds.daily_slot_id
        WHERE
            rr.rest_res_id = #{restResId}
    </select>

    <select id="getRestaurantReservationsByTripId" resultType="org.moa.reservation.dto.ReservationItemResponseDto">
        SELECT
            rr.reservation_id as reservationId,
            ri.rest_name as name,
            rr.rest_id as itemId,
            ri.rest_image_url as imageUrl,
            td.day as date,
            MIN(rr.created_at) as createdAt,
            'RESTAURANT' as resKind
        FROM rest_res rr
                JOIN restaurant_info ri ON rr.rest_id = ri.rest_id
                JOIN trip_day td ON rr.trip_day_id = td.trip_day_id
        WHERE td.trip_id = #{tripId}
          AND rr.status IN ('reserved', 'checked_in', 'completed')
        GROUP BY rr.reservation_id, ri.rest_name, rr.rest_id, ri.rest_image_url, td.day
        ORDER BY td.day
    </select>

    <select id="getRestaurantReservationsByDateAndMember" resultType="org.moa.reservation.dto.ReservationItemResponseDto">
        SELECT
            rr.reservation_id as reservationId,
            ri.rest_name as name,
            rr.rest_id as itemId,
            ri.rest_image_url as imageUrl,
            td.day as date,
            MIN(rr.created_at) as createdAt,
            'RESTAURANT' as resKind
        FROM rest_res rr
            JOIN restaurant_info ri ON rr.rest_id = ri.rest_id
            JOIN trip_day td ON rr.trip_day_id = td.trip_day_id
            JOIN trip t ON td.trip_id = t.trip_id
            JOIN trip_member tm ON t.trip_id = tm.trip_id
        WHERE td.trip_id = #{tripId}
          AND tm.member_id = #{memberId}
          AND td.day = #{date}
          AND rr.status IN ('reserved', 'checked_in', 'completed')
        GROUP BY rr.reservation_id, ri.rest_name, rr.rest_id, ri.rest_image_url, td.day
        ORDER BY MIN(rr.created_at)
    </select>

</mapper>