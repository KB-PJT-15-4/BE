<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.moa.reservation.transport.mapper.TransportMapper">
    <update id="cancelSeatsByReservationId">
        UPDATE tran_res
        SET reservation_id = NULL,
            trip_day_id = NULL,
            booked_at = NULL,
            status = 'AVAILABLE',
            updated_at = NOW()
        WHERE reservation_id = #{reservationId}
          AND status = 'PENDING'
    </update>
    <select id="selectTransports" resultType="org.moa.reservation.transport.dto.TranstInfoResponse">
        SELECT
        transport_id    AS transportId,
        departure_name  AS departureName,
        train_no        AS trainNo
        FROM transport_info
        WHERE is_visible = TRUE
        <if test="departureName != null and departureName.trim() != ''">
            AND departure_name LIKE CONCAT('%', #{departureName}, '%')
        </if>
        <if test="destinationName != null and destinationName.trim() != ''">
            AND arrival_name   LIKE CONCAT('%', #{destinationName}, '%')
        </if>
        <if test="departureDateTime != null">
            AND departure_time = #{departureDateTime}
        </if>
        ORDER BY transport_id DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>
    <select id="countTransports" resultType="java.lang.Integer">
        SELECT COUNT(*)
        FROM transport_info
        WHERE is_visible = TRUE
        <if test="departureName != null and departureName.trim() != ''">
            AND departure_name LIKE CONCAT('%', #{departureName}, '%')
        </if>
        <if test="destinationName != null and destinationName.trim() != ''">
            AND arrival_name   LIKE CONCAT('%', #{destinationName}, '%')
        </if>
        <if test="departureDateTime != null">
            AND departure_time = #{departureDateTime}
        </if>
    </select>
    <select id="selectSeatsByTransportId"
            parameterType="long"
            resultType="org.moa.reservation.transport.dto.TransSeatsInfoResponse">
        SELECT
            tran_res_id   AS tranResId,
            seat_room_no  AS seatRoomNo,
            seat_number   AS seatNumber,
            seat_type     AS seatType,
            status        AS status,
            price         AS price
        FROM tran_res
        WHERE transport_id = #{transportId}
        ORDER BY seat_room_no, seat_number
    </select>

    <select id="findStatusesByIds" parameterType="list" resultType="org.moa.reservation.transport.dto.TransResStatusDto">
        SELECT tran_res_id, status
        FROM tran_res
        WHERE tran_res_id IN
        <foreach item="id" collection="list" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    <select id="getTotalPriceByReservationId" resultType="java.math.BigDecimal">
        SELECT COALESCE(SUM(price), 0)
        FROM tran_res
        WHERE reservation_id = #{reservationId} AND status = 'PENDING'
    </select>
    <select id="selectTrainNoByReservationId" resultType="java.lang.String">
        SELECT I.train_no
        FROM transport_info I
        WHERE I.transport_id = (SELECT R.transport_id
                                FROM tran_res R
                                WHERE R.reservation_id = #{reservationId}
                                LIMIT 1);
    </select>
    <select id="findExistingTranResIds" resultType="java.lang.Long">
        SELECT tran_res_id
        FROM tran_res
        WHERE tran_res_id IN
        <foreach item="id" collection="tranResIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <update id="updateSeatsToPending">
        UPDATE tran_res
        SET
        reservation_id = #{reservationId},
        trip_day_id = #{tripDayId},
        booked_at = #{bookedAt},
        status = 'PENDING'
        WHERE tran_res_id IN
        <foreach item="id" collection="tranResIds" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>
    <update id="confirmSeatsByReservationId">
        UPDATE tran_res
        SET status = 'CONFIRMED',
            updated_at = CURRENT_TIMESTAMP,
            booked_at = CURRENT_TIMESTAMP
        WHERE reservation_id = #{reservationId}
          AND status = 'PENDING'
    </update>

    <select id="getTransportReservationsByTripId" resultType="org.moa.reservation.dto.ReservationItemResponseDto">
        SELECT
            tr.reservation_id as reservationId,
            ti.train_no as name,
            tr.transport_id as itemId,
            NULL as imageUrl,
            td.day as date,
            tr.created_at as createdAt,
            'TRANSPORT' as resKind
        FROM tran_res tr
            JOIN transport_info ti ON tr.transport_id = ti.transport_id
            JOIN trip_day td ON tr.trip_day_id = td.trip_day_id
        WHERE td.trip_id = #{tripId}
          AND tr.status = 'CONFIRMED'
        ORDER BY td.day
    </select>

    <select id="getTransportReservationsByDateAndMember" resultType="org.moa.reservation.dto.ReservationItemResponseDto">
        SELECT
            tr.reservation_id as reservationId,
            ti.train_no as name,
            tr.transport_id as itemId,
            NULL as imageUrl,
            td.day as date,
            tr.created_at as createdAt,
            'TRANSPORT' as resKind
        FROM tran_res tr
            JOIN transport_info ti ON tr.transport_id = ti.transport_id
            JOIN trip_day td ON tr.trip_day_id = td.trip_day_id
            JOIN trip t ON td.trip_id = t.trip_id
            JOIN trip_member tm ON t.trip_id = tm.trip_id
        WHERE td.trip_id = #{tripId}
          AND tm.member_id = #{memberId}
          AND td.day = #{date}
          AND tr.status = 'CONFIRMED'
        ORDER BY tr.created_at
    </select>
</mapper>
