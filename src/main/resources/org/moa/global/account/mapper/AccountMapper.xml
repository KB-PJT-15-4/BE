<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.moa.global.account.mapper.AccountMapper">

    <resultMap id="AccountResultMap" type="org.moa.global.account.entity.Account">
        <id     property="accountId"       column="account_id"/>
        <result property="memberId"        column="member_id"/>
        <result property="accountNumber"   column="account_number"/>
        <result property="accountPassword" column="account_password"/>
        <result property="bank"            column="bank_name"/>
        <result property="balance"         column="balance"/>
        <result property="isActive"        column="is_active"/>
        <result property="createdAt"       column="created_at"/>
        <result property="updatedAt"       column="updated_at"/>
    </resultMap>

    <update id="updateMemberIdByAccountNumber">
        UPDATE account
        SET member_id = #{memberId}
        WHERE account_number = #{accountNumber}
    </update>
    <select id="existsByAccountNumberAndAccountPassword" resultType="java.lang.Boolean">
        SELECT EXISTS (SELECT 1
                       FROM account
                       WHERE account_number = #{accountNumber}
                         AND account_password = #{accountPassword})
    </select>
    <select id="existsByNameAndAccountNumberAndAccountPassword" resultType="java.lang.Boolean">
        SELECT EXISTS(SELECT 1
                      FROM account
                      WHERE name = #{name}
                        AND account_number = #{accountNumber}
                        AND account_password = #{accountPassword})
    </select>
    <select id="searchAccountByMemberId" resultMap="AccountResultMap">
        SELECT * FROM account WHERE member_id = #{memberId}
    </select>
    <update id="transactionBalance" >
        UPDATE account
        SET balance = CASE
                          WHEN member_id = #{receiverId} THEN balance + #{amount}
                          WHEN member_id = #{senderId} THEN balance - #{amount}
                          ELSE balance
            END
        WHERE member_id IN (#{receiverId}, #{senderId})
    </update>
    <update id="withdraw">
        UPDATE account
        SET balance = balance - #{amount}
        WHERE account_number = #{accountNumber};
    </update>
</mapper>
