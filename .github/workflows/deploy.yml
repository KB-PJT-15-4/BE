name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        id: deploy
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "========================================="
            echo "Starting deployment process..."
            echo "========================================="
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /home/ubuntu/spring-deployment/BE
            
            # ìµœì‹  ì½”ë“œ pull (deploy.sh ë³´ì¡´)
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git stash
            git pull origin main
            git stash pop || true
            
            # deploy.sh ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x deploy.sh
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "ğŸš€ Running deployment script..."
            ./deploy.sh
            
            # ë°°í¬ ì™„ë£Œ
            echo "========================================="
            echo "âœ¨ Deployment completed successfully!"
            echo "========================================="

      - name: Send notification
        if: always()
        run: |
          if [ "${{ steps.deploy.outcome }}" == "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo "ë°°í¬ëœ ì»¤ë°‹: ${{ github.sha }}"
            echo "ë°°í¬ì: ${{ github.actor }}"
            echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
            # ì—¬ê¸°ì— Slack, Discord, ì´ë©”ì¼ ë“± ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
            echo "ì‹¤íŒ¨í•œ ì»¤ë°‹: ${{ github.sha }}"
            echo "ë°°í¬ì: ${{ github.actor }}"
          fi